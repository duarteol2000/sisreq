{% extends "core/base.html" %}

{% block title %}Movimentações/Empréstimos{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Movimentações/Empréstimos</h2>
  <p class="text-muted">
    Registre aqui a entrada de materiais comprados via suprimento de fundo,
    vinculando à Nota Fiscal e aos itens correspondentes.
  </p>
  <form method="post" enctype="multipart/form-data" id="entrada-compra-form">
    {% csrf_token %}

    <div class="card mb-3">
      <div class="card-header">
        Dados da Nota Fiscal / Documento
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label" for="{{ doc_form.tipo.id_for_label }}">Tipo</label>
            {{ doc_form.tipo }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="{{ doc_form.numero.id_for_label }}">Número</label>
            {{ doc_form.numero }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="{{ doc_form.data_emissao.id_for_label }}">Data de emissão</label>
            {{ doc_form.data_emissao }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="{{ doc_form.arquivo.id_for_label }}">Arquivo (PDF/Imagem)</label>
            {{ doc_form.arquivo }}
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label" for="{{ doc_form.descricao.id_for_label }}">Descrição / Observação</label>
          {{ doc_form.descricao }}
        </div>
        {% if doc_form.errors %}
          <div class="mt-3 alert alert-danger">
            {{ doc_form.errors }}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">
        Itens da movimentação
      </div>
      <div class="card-body">
        <p class="text-muted mb-2">
          Selecione um material, informe a quantidade e (opcionalmente) o valor unitário,
          depois clique em <strong>Adicionar item</strong>.
        </p>

        <div class="additem-grid mb-2">
          <div class="f">
            <label class="form-label">Material</label>
            <select id="mov-material" class="form-select">
              <option value="">Selecione um material</option>
              {% for m in materiais %}
                <option value="{{ m.id }}"
                        data-estoque="{{ m.quantidade_estoque }}"
                        data-unidade="{{ m.get_unidade_display }}">
                  {{ m.codigo }} - {{ m.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="f">
            <label class="form-label">Unidade</label>
            <input id="mov-unidade" class="form-control" type="text" readonly>
          </div>
          <div class="f">
            <label class="form-label">Qtd. em estoque</label>
            <input id="mov-estoque" class="form-control" type="text" readonly>
          </div>
          <div class="f">
            <label class="form-label">Qtd. recebida</label>
            <input id="mov-quantidade" class="form-control js-int" type="number" min="1">
          </div>
          <div class="f">
            <label class="form-label">Valor unitário</label>
            <input id="mov-valor-unitario" class="form-control" type="number" min="0" step="0.01">
          </div>
          <div class="f">
            <label class="form-label">&nbsp;</label>
            <button type="button" id="btn-adicionar-item" class="btn btn-secondary w-100">
              Adicionar item
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="table-wrap">
            <table class="table table-striped table-sm mt-2" id="itens-tabela">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Material</th>
                  <th>Unidade</th>
                  <th>Qtd. em estoque</th>
                  <th>Qtd. recebida</th>
                  <th>Valor unitário</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>

        <div id="itens-hidden"></div>

        <p class="text-muted small mb-0">
          Para cadastrar um novo material, use a tela de <strong>Novo material</strong>
          (abrindo em outra aba) e depois recarregue esta página para que ele apareça
          na lista.
        </p>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <a href="{% url 'estoque:listar_materiais' %}" class="btn btn-outline-secondary me-2">
        Cancelar
      </a>
      <button type="submit" class="btn btn-primary">
        Salvar movimentação
      </button>
    </div>
  </form>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const selectMaterial = document.getElementById('mov-material');
    const inputEstoque = document.getElementById('mov-estoque');
    const inputUnidade = document.getElementById('mov-unidade');
    const inputQuantidade = document.getElementById('mov-quantidade');
    const inputValor = document.getElementById('mov-valor-unitario');
    const btnAdicionar = document.getElementById('btn-adicionar-item');
    const tabelaBody = document.querySelector('#itens-tabela tbody');
    const hiddenContainer = document.getElementById('itens-hidden');

    if (!selectMaterial || !inputEstoque || !inputQuantidade || !btnAdicionar || !tabelaBody || !hiddenContainer) {
      return;
    }

    let linhaIndex = 0;

    function atualizarEstoque(){
      const opt = selectMaterial.options[selectMaterial.selectedIndex];
      if (!opt || !opt.value){
        inputEstoque.value = '';
        if (inputUnidade){ inputUnidade.value = ''; }
        return;
      }
      inputEstoque.value = opt.getAttribute('data-estoque') || '';
      if (inputUnidade){
        inputUnidade.value = opt.getAttribute('data-unidade') || '';
      }
    }

    selectMaterial.addEventListener('change', atualizarEstoque);

    btnAdicionar.addEventListener('click', function(){
      const opt = selectMaterial.options[selectMaterial.selectedIndex];
      const materialId = opt && opt.value ? opt.value : '';
      const materialTexto = opt && opt.value ? opt.textContent : '';
      const unidade = opt && opt.value ? (opt.getAttribute('data-unidade') || '') : '';
      const estoque = inputEstoque.value || '';
      const qtd = (inputQuantidade.value || '').trim();
      const valor = (inputValor.value || '').trim();

      if (!materialId){
        alert('Selecione um material.');
        return;
      }
      if (!qtd || parseInt(qtd, 10) <= 0){
        alert('Informe uma quantidade recebida maior que zero.');
        return;
      }

      const partes = materialTexto.split(' - ');
      const codigo = partes[0] || '';
      const nome = partes.slice(1).join(' - ');

      const tr = document.createElement('tr');
      tr.setAttribute('data-index', linhaIndex);
      tr.innerHTML = `
        <td>${codigo}</td>
        <td>${nome}</td>
        <td>${unidade}</td>
        <td>${estoque}</td>
        <td>${qtd}</td>
        <td>${valor || '-'}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger btn-remover-item">
            Remover
          </button>
        </td>
      `;
      tabelaBody.appendChild(tr);

      const hiddenMat = document.createElement('input');
      hiddenMat.type = 'hidden';
      hiddenMat.name = 'materiais[]';
      hiddenMat.value = materialId;
      hiddenMat.setAttribute('data-index', linhaIndex);

      const hiddenQtd = document.createElement('input');
      hiddenQtd.type = 'hidden';
      hiddenQtd.name = 'quantidades[]';
      hiddenQtd.value = qtd;
      hiddenQtd.setAttribute('data-index', linhaIndex);

      const hiddenVal = document.createElement('input');
      hiddenVal.type = 'hidden';
      hiddenVal.name = 'valores_unitarios[]';
      hiddenVal.value = valor;
      hiddenVal.setAttribute('data-index', linhaIndex);

      hiddenContainer.appendChild(hiddenMat);
      hiddenContainer.appendChild(hiddenQtd);
      hiddenContainer.appendChild(hiddenVal);

      linhaIndex += 1;
      inputQuantidade.value = '';
      inputValor.value = '';
    });

    tabelaBody.addEventListener('click', function(e){
      if (e.target && e.target.classList.contains('btn-remover-item')){
        const tr = e.target.closest('tr');
        const idx = tr.getAttribute('data-index');
        tr.remove();
        hiddenContainer.querySelectorAll('[data-index="'+idx+'"]').forEach(function(el){
          el.remove();
        });
      }
    });

    atualizarEstoque();
  });
  </script>
</div>
{% endblock %}
