{% extends "core/base.html" %}

{% block title %}Relatório de Consumo por Material (3 anos){% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
  @media print {
    @page {
      size: landscape;
    }
    .no-print,
    nav { display: none !important; }
  }
  </style>

  <div class="text-center mb-3">
    {% if request.user.secretaria.logo %}
      <img src="{{ request.user.secretaria.logo.url }}" alt="{{ request.user.secretaria }}" style="max-height:80px;">
    {% elif request.user.prefeitura.logo %}
      <img src="{{ request.user.prefeitura.logo.url }}" alt="{{ request.user.prefeitura }}" style="max-height:80px;">
    {% endif %}
    <h2 class="mt-2 mb-0">
      Consumo de Materiais - Últimos 3 anos
    </h2>
  </div>

  <div class="d-flex justify-content-end align-items-center mb-2 no-print">
    <form method="get" class="d-flex align-items-center me-2">
      <label for="filtro-ano" class="me-2 mb-0">Ano de referência:</label>
      <select id="filtro-ano"
              name="ano"
              class="form-select form-select-sm"
              onchange="this.form.submit()">
        {% for ano in anos_disponiveis %}
          <option value="{{ ano }}" {% if ano_referencia == ano %}selected{% endif %}>
            {{ ano }}
          </option>
        {% endfor %}
      </select>
    </form>
    <button type="button" class="btn btn-sm btn-primary" onclick="window.print();">
      Imprimir
    </button>
  </div>

  <div class="row mb-3">
    <div class="col-12 col-md-4">
      <div class="card border-secondary">
        <div class="card-body">
          <h6 class="card-title mb-1">Período considerado</h6>
          <p class="card-text mb-0">
            {{ anos_periodo.0 }} &ndash; {{ anos_periodo.2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-8 mt-2 mt-md-0">
      <div class="card border-info">
        <div class="card-body">
          <h6 class="card-title mb-1">Totais de consumo por ano</h6>
          <p class="card-text mb-0">
            {{ anos_periodo.0 }}: <strong>{{ total_por_ano.anos_periodo.0 }}</strong> &nbsp; | &nbsp;
            {{ anos_periodo.1 }}: <strong>{{ total_por_ano.anos_periodo.1 }}</strong> &nbsp; | &nbsp;
            {{ anos_periodo.2 }}: <strong>{{ total_por_ano.anos_periodo.2 }}</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped mt-2">
      <thead>
        <tr>
          <th>Código</th>
          <th>Material</th>
          <th class="text-end">Consumo {{ anos_periodo.0 }}</th>
          <th class="text-end">Consumo {{ anos_periodo.1 }}</th>
          <th class="text-end">Consumo {{ anos_periodo.2 }}</th>
          <th class="text-end">Média anual (3 anos)</th>
        </tr>
      </thead>
      <tbody>
        {% for linha in linhas %}
        <tr>
          <td>{{ linha.codigo }}</td>
          <td>{{ linha.nome }}</td>
          <td class="text-end">{{ linha.consumo_ano1 }}</td>
          <td class="text-end">{{ linha.consumo_ano2 }}</td>
          <td class="text-end">{{ linha.consumo_ano3 }}</td>
          <td class="text-end">
            {% if linha.media %}
              {{ linha.media|floatformat:1 }}
            {% else %}
              0,0
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6">Nenhum consumo registrado para o período considerado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <p class="text-muted small mb-0">
      <strong>Observação:</strong>
      este relatório considera apenas o <strong>consumo real</strong> de materiais,
      isto é, as quantidades <strong>liberadas</strong> em requisições com
      <strong>data de entrega</strong> registrada. A média anual é calculada com base
      na soma dos três anos do período dividida por 3, servindo como referência para
      projeções de consumo no ano subsequente.
    </p>
  </div>
</div>
{% endblock %}

