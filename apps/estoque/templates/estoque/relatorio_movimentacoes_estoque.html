{% extends "core/base.html" %}

{% block title %}Relatório de Movimentações de Estoque{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
  @media print {
    @page {
      size: landscape;
    }
    .no-print,
    nav { display: none !important; }
  }
  </style>

  <div class="text-center mb-3">
    {% if request.user.secretaria.logo %}
      <img src="{{ request.user.secretaria.logo.url }}" alt="{{ request.user.secretaria }}" style="max-height:80px;">
    {% elif request.user.prefeitura.logo %}
      <img src="{{ request.user.prefeitura.logo.url }}" alt="{{ request.user.prefeitura }}" style="max-height:80px;">
    {% endif %}
    <h2 class="mt-2 mb-0">Relatório de Movimentações / Empréstimos de Estoque</h2>
  </div>

  <div class="d-flex justify-content-end align-items-center mb-2 no-print">
    <button type="button" class="btn btn-sm btn-primary" onclick="window.print();">
      Imprimir
    </button>
  </div>

  <form method="get" class="row g-2 mt-3 mb-3 no-print">
    <div class="col-md-3">
      <label class="form-label">Data início</label>
      <input type="date"
             name="data_inicio"
             value="{{ data_inicio|date:'Y-m-d' }}"
             class="form-control form-control-sm">
    </div>
    <div class="col-md-3">
      <label class="form-label">Data fim</label>
      <input type="date"
             name="data_fim"
             value="{{ data_fim|date:'Y-m-d' }}"
             class="form-control form-control-sm">
    </div>
    <div class="col-md-3">
      <label class="form-label">Tipo de movimentação</label>
      <select name="tipo_negocio" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for value, label in tipo_negocio_choices %}
          <option value="{{ value }}" {% if tipo_negocio == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Direção</label>
      <select name="direcao" class="form-select form-select-sm">
        <option value="">Entradas e saídas</option>
        <option value="entrada" {% if direcao == 'entrada' %}selected{% endif %}>Somente entradas</option>
        <option value="saida" {% if direcao == 'saida' %}selected{% endif %}>Somente saídas</option>
      </select>
    </div>
    <div class="col-md-4 mt-2">
      <label class="form-label">Órgão externo</label>
      <select name="orgao_externo" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for value, label in orgao_externo_choices %}
          <option value="{{ value }}" {% if orgao_externo == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end mt-2">
      <button type="submit" class="btn btn-sm btn-primary w-100">Filtrar</button>
    </div>
  </form>

  <div class="row mb-3">
    <div class="col-6 col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h6 class="card-title">Total de movimentos</h6>
          <p class="card-text fw-bold">{{ total_movimentos }}</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <h6 class="card-title">Total de entradas</h6>
          <p class="card-text fw-bold">{{ total_entradas }}</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 mt-2 mt-md-0">
      <div class="card border-danger">
        <div class="card-body">
          <h6 class="card-title">Total de saídas</h6>
          <p class="card-text fw-bold">{{ total_saidas }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-sm mt-2">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Tipo</th>
          <th>Natureza</th>
          <th>Órgão externo</th>
          <th>Documento</th>
          <th>Código</th>
          <th>Material</th>
          <th class="text-end">Quantidade</th>
          <th class="text-end">Valor unitário</th>
          <th>Usuário</th>
        </tr>
      </thead>
      <tbody>
        {% for mov in movimentos %}
        <tr>
          <td>{{ mov.data_movimento|date:"d/m/Y H:i" }}</td>
          <td>
            {% if mov.tipo == "ENTRADA" or mov.tipo == "AJUSTE_POSITIVO" %}
              Entrada
            {% elif mov.tipo == "AJUSTE_NEGATIVO" %}
              Saída
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ mov.get_tipo_negocio_display }}</td>
          <td>
            {% if mov.orgao_externo %}
              {{ mov.get_orgao_externo_display }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            {% if mov.documento %}
              {{ mov.documento.get_tipo_display }}{% if mov.documento.numero %} {{ mov.documento.numero }}{% endif %}
              {% if mov.documento.arquivo %}
                <br>
                <a href="{{ mov.documento.arquivo.url }}" target="_blank">Ver anexo</a>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>{{ mov.material.codigo }}</td>
          <td>{{ mov.material.nome }}</td>
          <td class="text-end">{{ mov.quantidade }}</td>
          <td class="text-end">
            {% if mov.valor_unitario %}
              {{ mov.valor_unitario }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ mov.usuario.nome_completo }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10">Nenhuma movimentação encontrada para o período informado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

