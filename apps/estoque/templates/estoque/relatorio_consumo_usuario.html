{% extends "core/base.html" %}

{% block title %}Consumo por Usuário{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
  @media print {
    @page {
      size: landscape;
    }
    .no-print,
    nav { display: none !important; }
  }
  </style>
  <div class="text-center mb-3">
    {% if request.user.secretaria.logo %}
      <img src="{{ request.user.secretaria.logo.url }}" alt="{{ request.user.secretaria }}" style="max-height:80px;">
    {% elif request.user.prefeitura.logo %}
      <img src="{{ request.user.prefeitura.logo.url }}" alt="{{ request.user.prefeitura }}" style="max-height:80px;">
    {% endif %}
  </div>
  <h2 class="text-center mb-2">Relatório de Consumo por Usuário</h2>
  <div class="d-flex justify-content-end align-items-center mb-2 no-print">
    <form method="get" class="d-flex align-items-center me-2">
      <label for="filtro-ano" class="me-2 mb-0">Ano:</label>
      <select id="filtro-ano"
              name="ano"
              class="form-select form-select-sm"
              onchange="this.form.submit()">
        {% for ano in anos_disponiveis %}
          <option value="{{ ano }}" {% if ano_selecionado == ano %}selected{% endif %}>
            {{ ano }}
          </option>
        {% endfor %}
      </select>
    </form>
    <button type="button" class="btn btn-sm btn-primary" onclick="window.print();">
      Imprimir
    </button>
  </div>

  <div class="row mb-3">
    <div class="col-6 col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h6 class="card-title">Total consumido no ano</h6>
          <p class="card-text fw-bold">{{ total_geral }}</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card border-secondary">
        <div class="card-body">
          <h6 class="card-title">Média de consumo por usuário</h6>
          <p class="card-text fw-bold">
            {% if usuarios %}
              {{ media_consumo|floatformat:1 }}
            {% else %}
              0,0
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-7">
      <h4>Ranking de consumo</h4>
      <div class="table-responsive">
        <table class="table table-sm table-striped mt-2">
          <thead>
            <tr>
              <th>#</th>
              <th>Usuário</th>
              <th>Matrícula</th>
              <th>Setor</th>
              <th class="text-end">Total consumido</th>
              <th class="text-end">% do total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usuarios %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ u.nome }}</td>
              <td>{{ u.matricula|default:"-" }}</td>
              <td>{{ u.setor|default:"-" }}</td>
              <td class="text-end">{{ u.total }}</td>
              <td class="text-end">
                {% if total_geral %}
                  {{ u.percentual|floatformat:1 }}%
                {% else %}
                  0,0%
                {% endif %}
              </td>
              <td>
                {% if u.status_consumo == "Acima da média" %}
                  <span class="badge text-bg-danger">{{ u.status_consumo }}</span>
                {% else %}
                  <span class="badge text-bg-secondary">{{ u.status_consumo }}</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7">Nenhum consumo registrado para o ano selecionado.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-5" style="page-break-inside: avoid;">
      <h4 class="mb-2">Top 10 consumidores (barras)</h4>
      <canvas id="chart-consumo-usuario" height="180"></canvas>
    </div>
  </div>

  <h4 class="mt-4">Consumo mês a mês por usuário</h4>
  <div class="table-responsive">
    <table class="table table-sm table-striped mt-2">
      <thead>
        <tr>
          <th>Usuário</th>
          <th class="text-end">Jan</th>
          <th class="text-end">Fev</th>
          <th class="text-end">Mar</th>
          <th class="text-end">Abr</th>
          <th class="text-end">Mai</th>
          <th class="text-end">Jun</th>
          <th class="text-end">Jul</th>
          <th class="text-end">Ago</th>
          <th class="text-end">Set</th>
          <th class="text-end">Out</th>
          <th class="text-end">Nov</th>
          <th class="text-end">Dez</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr>
          <td>{{ u.nome }}</td>
          {% for mes_val in u.mensal %}
          <td class="text-end">{{ mes_val }}</td>
          {% endfor %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="13">Nenhum consumo registrado para o ano selecionado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <p class="text-muted small mb-0">
      <strong>Observação:</strong>
      o consumo considerado é sempre o <strong>consumo real</strong> (quantidade liberada)
      em requisições <strong>entregues</strong> no ano selecionado, agrupado por usuário solicitante.
      Usuários com consumo maior ou igual ao dobro da média anual são marcados como
      <strong>"Acima da média"</strong>.
    </p>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const ctx = document.getElementById('chart-consumo-usuario');
  if (!ctx) return;

  const labels = {{ chart_labels_json|safe }};
  const data = {{ chart_data_json|safe }};

  if (!labels.length) {
    return;
  }

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total consumido',
        data: data,
        backgroundColor: 'rgba(13, 110, 253, 0.6)',
        borderColor: 'rgba(13, 110, 253, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
});
</script>
{% endblock %}
