{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <title>Entrega de Materiais - {{ requisicao.numero_requisicao }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { font-size: 12px; }
      .report-container{ max-width:900px; margin:0 auto; padding:20px 24px; }
      .report-header{ text-align:center; margin-bottom:12px; }
      .report-header img{ max-height:80px; margin-bottom:6px; }
      .report-title{ font-size:20px; font-weight:700; text-transform:uppercase; }
      .sub-header{ display:flex; justify-content:space-between; margin-top:12px; }
      .sub-header .block{ width:48%; }
      .sub-header p{ margin-bottom:2px; }
      .items-table th, .items-table td{ padding:4px 6px !important; }
      .items-table th{ background:#f1f5f9; }
      .text-right{ text-align:right; }
      .signatures{ margin-top:32px; display:flex; justify-content:space-between; }
      .signatures .sig{ width:46%; text-align:center; }
      .sig-line{ border-top:1px solid #000; margin-top:32px; padding-top:4px; }
      @media print{
        .no-print{ display:none !important; }
        body{ margin:0; }
      }
    </style>
  </head>
  <body>
    <div class="report-container">
      <div class="d-flex justify-content-between align-items-center no-print mb-2">
        <button class="btn btn-sm btn-secondary" onclick="window.close();">Fechar</button>
        <button class="btn btn-sm btn-primary" onclick="window.print();">Imprimir</button>
      </div>

      <div class="report-header">
        {% if requisicao.secretaria.logo %}
          <img src="{{ requisicao.secretaria.logo.url }}" alt="{{ requisicao.secretaria }}">
        {% elif requisicao.prefeitura.logo %}
          <img src="{{ requisicao.prefeitura.logo.url }}" alt="{{ requisicao.prefeitura }}">
        {% else %}
          <img src="{% static 'img/logo-semam.jpg' %}" alt="Logo">
        {% endif %}
        <div class="report-title">Entrega de Materiais</div>
      </div>

      <div class="sub-header">
        <div class="block">
          <p><strong>Solicitante:</strong> {{ requisicao.solicitante.nome_completo }}</p>
          <p><strong>Nº Requisição:</strong> {{ requisicao.numero_requisicao }}</p>
          <p><strong>Matrícula:</strong> {{ requisicao.solicitante.matricula|default:"-" }}</p>
          <p><strong>Setor:</strong> {{ requisicao.setor|default:"-" }}</p>
          <p><strong>Prefeitura:</strong> {{ requisicao.prefeitura }}</p>
          <p><strong>Secretaria:</strong> {{ requisicao.secretaria }}</p>
          <p><strong>Data solicitação:</strong> {{ requisicao.data_criacao|date:"d/m/Y H:i" }}</p>
        </div>
        <div class="block text-end">
          <p><strong>Data aprovação:</strong>
            {% if requisicao.data_aprovacao %}
              {{ requisicao.data_aprovacao|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </p>
          <p><strong>Data entrega:</strong>
            {% if requisicao.data_entrega %}
              {{ requisicao.data_entrega|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </p>
          <p><strong>Aprovado por:</strong>
            {% if requisicao.aprovado_por %}
              {{ requisicao.aprovado_por.nome_completo }}
            {% else %}
              -
            {% endif %}
          </p>
          <p><strong>Entregue por:</strong>
            {% if recibo and recibo.emitido_por %}
              {{ recibo.emitido_por.nome_completo }}
            {% elif requisicao.aprovado_por %}
              {{ requisicao.aprovado_por.nome_completo }}
            {% else %}
              -
            {% endif %}
          </p>
          <p><strong>Data impressão:</strong> {{ agora|date:"d/m/Y H:i" }}</p>
          <p><strong>Status:</strong> {{ requisicao.get_status_display }}</p>
        </div>
      </div>

      <p class="mt-2"><strong>Observação do administrador:</strong> {{ requisicao.observacao_administrador|default:"-" }}</p>

      <h5 class="mt-3">Itens da Requisição</h5>
      <table class="table table-bordered table-sm items-table">
        <thead>
          <tr>
            <th>Código</th>
            <th>Material</th>
            <th class="text-right">Unidade</th>
            <th class="text-right">Qtd. solicitada</th>
            <th class="text-right">Qtd. liberada</th>
            <th>Situação</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
          <tr>
            <td>{{ item.material.codigo }}</td>
            <td>{{ item.material.nome }}</td>
            <td class="text-right">{{ item.material.get_unidade_display }}</td>
            <td class="text-right">{{ item.quantidade_solicitada }}</td>
            <td class="text-right">{{ item.quantidade_liberada }}</td>
            <td>
              {% if item.quantidade_liberada == 0 %}
                Não atendido
              {% elif item.quantidade_liberada < item.quantidade_solicitada %}
                Parcialmente atendido
              {% else %}
                Atendido
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">Nenhum item na requisição.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <p class="mt-2">
        <strong>Consumo real (total liberado):</strong>
        {{ total_consumo }}
      </p>

      <div class="signatures">
        <div class="sig">
          <div class="sig-line">Assinatura do Solicitante</div>
          <div>{{ requisicao.solicitante.nome_completo }}</div>
        </div>
        <div class="sig">
          <div class="sig-line">Responsável pela Entrega</div>
          <div>
            {% if recibo and recibo.emitido_por %}
              {{ recibo.emitido_por.nome_completo }}
            {% elif requisicao.aprovado_por %}
              {{ requisicao.aprovado_por.nome_completo }}
            {% else %}
              &nbsp;
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
