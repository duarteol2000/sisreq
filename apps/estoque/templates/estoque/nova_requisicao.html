{% extends "core/base.html" %}

{% block title %}Nova Requisição{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card card-compact">
    <div class="card-body">
      <h2 class="card-title mb-2">Nova Requisição</h2>
      <p class="text-muted mb-2">Selecione um ou mais materiais e informe as quantidades desejadas.</p>

      <form method="post" class="mt-2" id="nova-requisicao-form">
        {% csrf_token %}

        <h5 class="mt-2 mb-2">Itens da Requisição</h5>

        <div class="additem-grid mb-2">
          <div class="f">
            <label class="form-label">Material</label>
            <select id="item-material" class="form-select">
              <option value="">Selecione um material</option>
              {% for m in materiais %}
                <option value="{{ m.id }}"
                        data-estoque="{{ m.quantidade_estoque }}"
                        data-unidade="{{ m.get_unidade_display }}"
                        {% if material_inicial and m.id == material_inicial.id %}selected{% endif %}>
                  {{ m.codigo }} - {{ m.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="f">
            <label class="form-label">Unidade</label>
            <input id="item-unidade" class="form-control" type="text" readonly>
          </div>
          <div class="f">
            <label class="form-label">Qtd. em estoque</label>
            <input id="item-estoque" class="form-control" type="text" readonly>
          </div>
          <div class="f">
            <label class="form-label">Qtd. solicitada</label>
            <input id="item-quantidade" class="form-control js-int" type="number" min="1">
          </div>
          <div class="f">
            <label class="form-label">&nbsp;</label>
            <button type="button" id="btn-adicionar-item" class="btn btn-secondary w-100">
              Adicionar item
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="table-wrap">
            <table class="table table-striped table-sm mt-2" id="itens-tabela">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Material</th>
                  <th>Unidade</th>
                  <th>Qtd. em estoque</th>
                  <th>Qtd. solicitada</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>

        <div id="itens-hidden"></div>

        <div class="mt-3 d-flex justify-content-between">
          <a href="{% url 'estoque:listar_requisicoes' %}" class="btn btn-outline-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Enviar requisição</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const selectMaterial = document.getElementById('item-material');
  const inputEstoque = document.getElementById('item-estoque');
  const inputUnidade = document.getElementById('item-unidade');
  const inputQuantidade = document.getElementById('item-quantidade');
  const btnAdicionar = document.getElementById('btn-adicionar-item');
  const tabelaBody = document.querySelector('#itens-tabela tbody');
  const hiddenContainer = document.getElementById('itens-hidden');

  if (!selectMaterial || !inputEstoque || !inputQuantidade || !btnAdicionar || !tabelaBody || !hiddenContainer) {
    return;
  }

  let linhaIndex = 0;

  function atualizarEstoque(){
    const opt = selectMaterial.options[selectMaterial.selectedIndex];
    if (!opt || !opt.value){
      inputEstoque.value = '';
      if (inputUnidade){ inputUnidade.value = ''; }
      return;
    }
    inputEstoque.value = opt.getAttribute('data-estoque') || '';
    if (inputUnidade){
      inputUnidade.value = opt.getAttribute('data-unidade') || '';
    }
  }

  selectMaterial.addEventListener('change', atualizarEstoque);

  btnAdicionar.addEventListener('click', function(){
    const opt = selectMaterial.options[selectMaterial.selectedIndex];
    const materialId = opt && opt.value ? opt.value : '';
    const materialTexto = opt && opt.value ? opt.textContent : '';
    const unidade = opt && opt.value ? (opt.getAttribute('data-unidade') || '') : '';
    const estoque = inputEstoque.value || '';
    const qtd = (inputQuantidade.value || '').trim();

    if (!materialId){
      alert('Selecione um material.');
      return;
    }
    if (!qtd || parseInt(qtd, 10) <= 0){
      alert('Informe uma quantidade solicitada maior que zero.');
      return;
    }

    const tr = document.createElement('tr');
    tr.setAttribute('data-index', linhaIndex);
    tr.innerHTML = `
      <td>${materialTexto.split(' - ')[0]}</td>
      <td>${materialTexto.split(' - ').slice(1).join(' - ')}</td>
      <td>${unidade}</td>
      <td>${estoque}</td>
      <td>${qtd}</td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger btn-remover-item">
          Remover
        </button>
      </td>
    `;
    tabelaBody.appendChild(tr);

    const hiddenMat = document.createElement('input');
    hiddenMat.type = 'hidden';
    hiddenMat.name = 'materiais[]';
    hiddenMat.value = materialId;
    hiddenMat.setAttribute('data-index', linhaIndex);

    const hiddenQtd = document.createElement('input');
    hiddenQtd.type = 'hidden';
    hiddenQtd.name = 'quantidades[]';
    hiddenQtd.value = qtd;
    hiddenQtd.setAttribute('data-index', linhaIndex);

    hiddenContainer.appendChild(hiddenMat);
    hiddenContainer.appendChild(hiddenQtd);

    linhaIndex += 1;
    inputQuantidade.value = '';
  });

  tabelaBody.addEventListener('click', function(e){
    if (e.target && e.target.classList.contains('btn-remover-item')){
      const tr = e.target.closest('tr');
      const idx = tr.getAttribute('data-index');
      tr.remove();
      hiddenContainer.querySelectorAll('[data-index="'+idx+'"]').forEach(function(el){
        el.remove();
      });
    }
  });

  atualizarEstoque();
});
</script>
{% endblock %}
