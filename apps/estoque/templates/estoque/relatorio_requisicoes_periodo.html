{% extends "core/base.html" %}

{% block title %}Requisições por Período{% endblock %}

{% block content %}
<div class="container mt-4">
  <style>
  @media print {
    .no-print,
    nav { display: none !important; }
  }
  </style>
  <div class="text-center mb-3">
    {% if request.user.secretaria.logo %}
      <img src="{{ request.user.secretaria.logo.url }}" alt="{{ request.user.secretaria }}" style="max-height:80px;">
    {% elif request.user.prefeitura.logo %}
      <img src="{{ request.user.prefeitura.logo.url }}" alt="{{ request.user.prefeitura }}" style="max-height:80px;">
    {% endif %}
  </div>
  <h2 class="text-center mb-2">Relatório de Requisições por Período</h2>
  <div class="d-flex justify-content-end align-items-center mb-2 no-print">
    <button type="button" class="btn btn-sm btn-primary" onclick="window.print();">
      Imprimir
    </button>
  </div>
  <form method="get" class="row g-2 mt-3 mb-3 no-print">
    <div class="col-md-3">
      <label class="form-label">Data início</label>
      <input type="date"
             name="data_inicio"
             value="{{ data_inicio|date:'Y-m-d' }}"
             class="form-control form-control-sm">
    </div>
    <div class="col-md-3">
      <label class="form-label">Data fim</label>
      <input type="date"
             name="data_fim"
             value="{{ data_fim|date:'Y-m-d' }}"
             class="form-control form-control-sm">
    </div>
    <div class="col-md-3">
      <label class="form-label">Agrupamento</label>
      <select name="agrupamento" class="form-select form-select-sm">
        <option value="diario" {% if agrupamento == 'diario' %}selected{% endif %}>Diário</option>
        <option value="semanal" {% if agrupamento == 'semanal' %}selected{% endif %}>Semanal</option>
        <option value="mensal" {% if agrupamento == 'mensal' %}selected{% endif %}>Mensal</option>
        <option value="anual" {% if agrupamento == 'anual' %}selected{% endif %}>Anual</option>
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-sm btn-primary w-100">Filtrar</button>
    </div>
  </form>

  <div class="row mb-3">
    <div class="col-6 col-md-3">
      <div class="card border-primary">
        <div class="card-body">
          <h6 class="card-title">Total de requisições</h6>
          <p class="card-text fw-bold">{{ total_requisicoes }}</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-success">
        <div class="card-body">
          <h6 class="card-title">Consumo real no período</h6>
          <p class="card-text fw-bold">{{ total_consumo }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h4>Série temporal</h4>
      <div class="table-responsive">
        <table class="table table-sm table-striped mt-2">
          <thead>
            <tr>
              <th>Período</th>
              <th class="text-end">Qtd. requisições</th>
              <th class="text-end">Consumo real</th>
            </tr>
          </thead>
          <tbody>
            {% for s in series %}
            <tr>
              <td>{{ s.label }}</td>
              <td class="text-end">{{ s.qtd }}</td>
              <td class="text-end">{{ s.consumo }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3">Nenhum dado encontrado para o período informado.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-6">
      <h4>Gráfico (barras + linha)</h4>
      <canvas id="chart-requisicoes-periodo" height="220"></canvas>
    </div>
  </div>
  <div class="mt-3">
    <p class="text-muted small mb-0">
      <strong>Observação:</strong>
      a contagem de requisições é feita pela <strong>data de criação</strong> (data_criacao),
      enquanto o <strong>consumo real</strong> considera apenas as requisições com
      <strong>data de entrega</strong> (data_entrega) preenchida.
    </p>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const ctx = document.getElementById('chart-requisicoes-periodo');
  if (!ctx) return;

  const labels = {{ labels|safe }};
  const dadosQtd = {{ dados_qtd|safe }};
  const dadosConsumo = {{ dados_consumo|safe }};

  if (!labels.length) {
    return;
  }

  new Chart(ctx, {
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: 'Qtd. requisições',
          data: dadosQtd,
          backgroundColor: 'rgba(13, 110, 253, 0.6)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 1,
          yAxisID: 'y',
        },
        {
          type: 'line',
          label: 'Consumo real',
          data: dadosConsumo,
          borderColor: 'rgba(25, 135, 84, 1)',
          backgroundColor: 'rgba(25, 135, 84, 0.2)',
          borderWidth: 2,
          tension: 0.2,
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          beginAtZero: true,
          ticks: { precision: 0 }
        },
        y1: {
          type: 'linear',
          position: 'right',
          beginAtZero: true,
          grid: {
            drawOnChartArea: false,
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
