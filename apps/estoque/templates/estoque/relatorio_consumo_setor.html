{% extends "core/base.html" %}

{% block title %}Consumo por Setor{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
  @media print {
    @page {
      size: landscape;
    }
    .no-print,
    nav { display: none !important; }
  }
  </style>

  <div class="text-center mb-3">
    {% if request.user.secretaria.logo %}
      <img src="{{ request.user.secretaria.logo.url }}" alt="{{ request.user.secretaria }}" style="max-height:80px;">
    {% elif request.user.prefeitura.logo %}
      <img src="{{ request.user.prefeitura.logo.url }}" alt="{{ request.user.prefeitura }}" style="max-height:80px;">
    {% endif %}
  </div>
  <h2 class="text-center mb-2">Relatório de Consumo por Setor</h2>

  <div class="d-flex justify-content-end align-items-center mb-2 no-print">
    <form method="get" class="d-flex align-items-center me-2">
      <label for="filtro-ano" class="me-2 mb-0">Ano:</label>
      <select id="filtro-ano"
              name="ano"
              class="form-select form-select-sm"
              onchange="this.form.submit()">
        {% for ano in anos_disponiveis %}
          <option value="{{ ano }}" {% if ano_selecionado == ano %}selected{% endif %}>
            {{ ano }}
          </option>
        {% endfor %}
      </select>
    </form>
    <button type="button" class="btn btn-sm btn-primary" onclick="window.print();">
      Imprimir
    </button>
  </div>

  <div class="row mb-3">
    <div class="col-6 col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h6 class="card-title">Total consumido no ano</h6>
          <p class="card-text fw-bold">{{ total_geral }}</p>
        </div>
      </div>
    </div>
    {% if setor_top %}
    <div class="col-6 col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <h6 class="card-title">Setor com maior consumo</h6>
          <p class="card-text fw-bold mb-1">
            {{ setor_top.nome }} ({{ setor_top.sigla_secretaria }})
          </p>
          <p class="card-text mb-0">
            {{ setor_top.total }} itens ({{ setor_top.percentual|floatformat:1 }}% do total)
          </p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="row">
    <div class="col-md-7">
      <h4>Ranking de consumo por setor</h4>
      <div class="table-responsive">
        <table class="table table-sm table-striped mt-2">
          <thead>
            <tr>
              <th>#</th>
              <th>Setor</th>
              <th>Secretaria</th>
              <th class="text-end">Total consumido</th>
              <th class="text-end">% do total</th>
            </tr>
          </thead>
          <tbody>
            {% for s in setores %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ s.nome }}</td>
              <td>{{ s.sigla_secretaria }}</td>
              <td class="text-end">{{ s.total }}</td>
              <td class="text-end">
                {% if total_geral %}
                  {{ s.percentual|floatformat:1 }}%
                {% else %}
                  0,0%
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5">Nenhum consumo registrado para o ano selecionado.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-5" style="page-break-inside: avoid;">
      <h4 class="mb-2">Top 10 setores consumidores (barras)</h4>
      <canvas id="chart-consumo-setor" height="180"></canvas>
    </div>
  </div>

  <h4 class="mt-4">Materiais mais consumidos por setor</h4>
  <div class="table-responsive">
    <table class="table table-sm table-striped mt-2">
      <thead>
        <tr>
          <th>Setor</th>
          <th>Código</th>
          <th>Material</th>
          <th class="text-end">Total consumido</th>
        </tr>
      </thead>
      <tbody>
        {% for s in setores %}
          {% with mats=s.top_materiais|slice:":2" %}
            {% if mats %}
              {% for mat in mats %}
              <tr>
                {% if forloop.first %}
                  <td rowspan="{{ mats|length }}">{{ s.nome }}</td>
                {% endif %}
                <td>{{ mat.codigo }}</td>
                <td>{{ mat.nome }}</td>
                <td class="text-end">{{ mat.total }}</td>
              </tr>
              {% endfor %}
            {% else %}
            <tr>
              <td>{{ s.nome }}</td>
              <td colspan="3">Nenhum material consumido registrado para este setor.</td>
            </tr>
            {% endif %}
          {% endwith %}
        {% empty %}
        <tr>
          <td colspan="4">Nenhum consumo registrado para o ano selecionado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <p class="text-muted small mb-0">
      <strong>Observação:</strong>
      o consumo considerado é sempre o <strong>consumo real</strong> (quantidade liberada)
      em requisições <strong>entregues</strong> no ano selecionado, agrupado pelo
      <strong>setor da requisição</strong>. Como o setor é congelado no momento da
      solicitação, mudanças posteriores de setor do usuário não alteram o histórico
      destes relatórios.
    </p>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const ctx = document.getElementById('chart-consumo-setor');
  if (!ctx) return;

  const labels = {{ chart_labels_json|safe }};
  const data = {{ chart_data_json|safe }};

  if (!labels.length) {
    return;
  }

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total consumido',
        data: data,
        backgroundColor: 'rgba(25, 135, 84, 0.6)',
        borderColor: 'rgba(25, 135, 84, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
});
</script>
{% endblock %}
