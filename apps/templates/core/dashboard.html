{% extends "core/base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
  body {
    background: #f4f6fc;
    color: #0f172a;
  }
  .dashboard-soft .card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    color: #0f172a;
  }
  .dashboard-soft .table {
    background: #ffffff;
    color: #0f172a;
  }
  .dashboard-soft .table thead th {
    background: #f5f7fa;
  }
  .dashboard-soft .table-striped tbody tr:nth-of-type(odd) {
    background-color: #fafcff;
  }
</style>
{% endblock %}

{% block content %}
<style>
  body {
    background: #e8ecf5;
    color: #0f172a;
  }
</style>
<div class="container mt-4 dashboard-soft">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-0">Dashboard da Secretaria</h2>
    <form method="get" class="d-flex align-items-center">
      <label for="filtro-ano-topo" class="me-2 mb-0">Ano:</label>
      <select id="filtro-ano-topo"
              name="ano"
              class="form-select form-select-sm"
              onchange="this.form.submit()">
        {% for ano in anos_disponiveis %}
          <option value="{{ ano }}" {% if ano_selecionado == ano %}selected{% endif %}>
            {{ ano }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="row mt-3">
    <div class="col-md-3">
      <div class="card text-bg-primary mb-3">
        <div class="card-body">
          <h5 class="card-title">Materiais cadastrados</h5>
          <p class="card-text display-6">{{ total_materiais }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-success mb-3">
        <div class="card-body">
          <h5 class="card-title">Total de requisições</h5>
          <p class="card-text display-6">{{ total_requisicoes }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-warning mb-3">
        <div class="card-body">
          <h5 class="card-title">Requisições pendentes</h5>
          <p class="card-text display-6">{{ requisicoes_pendentes }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-danger mb-3">
        <div class="card-body">
          <h5 class="card-title">Requisições negadas</h5>
          <p class="card-text display-6">{{ requisicoes_negadas }}</p>
        </div>
      </div>
    </div>
  </div>

  <h3 class="mt-4">Últimos materiais cadastrados</h3>
  <table class="table table-striped mt-2">
    <thead>
      <tr>
        <th>Código</th>
        <th>Nome</th>
        <th>Quantidade</th>
      </tr>
    </thead>
    <tbody>
      {% for material in materiais %}
      <tr>
        <td>{{ material.codigo }}</td>
        <td>{{ material.nome }}</td>
        <td>{{ material.quantidade_estoque }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3">Nenhum material cadastrado.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row mt-4">
    <div class="col-md-6">
      <h3 class="mb-2">Top 10 materiais que mais saíram</h3>
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Material</th>
            <th class="text-end">Qtd. liberada</th>
          </tr>
        </thead>
        <tbody>
          {% for m in top_materiais %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ m.material__codigo }} - {{ m.material__nome }}</td>
            <td class="text-end">{{ m.total_liberado }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">Ainda não há saídas registradas para o ano selecionado.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
      <h3 class="mb-2">Gráfico de saídas por material</h3>
      <canvas id="chart-top-materiais" height="180"></canvas>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const ctx = document.getElementById('chart-top-materiais');
  if (!ctx) return;

  const labels = {{ chart_labels_json|safe }};
  const data = {{ chart_data_json|safe }};

  if (!labels.length) {
    return;
  }

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade liberada',
        data: data,
        backgroundColor: 'rgba(13, 110, 253, 0.6)',
        borderColor: 'rgba(13, 110, 253, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
